# **************************************************************************** #
#                                                                              #
#                                                         :::      ::::::::    #
#    Makefile                                           :+:      :+:    :+:    #
#                                                     +:+ +:+         +:+      #
#    By: rivoinfo <rivoinfo@student.42.fr>          +#+  +:+       +#+         #
#                                                 +#+#+#+#+#+   +#+            #
#    Created: 2025/08/07 18:21:32 by rhanitra          #+#    #+#              #
#    Updated: 2025/08/22 13:16:14 by rivoinfo         ###   ########.fr        #
#                                                                              #
# **************************************************************************** #


NAME = inception

COMPOSE = docker compose
COMPOSE_FILE = -f ./srcs/docker-compose.yml
ENV_FILE = --env-file srcs/.env

DOMAIN=rhanitra.42.fr

export USER = $(shell whoami)
export DATA_PATH = /home/$(USER)/data

all: init-dirs init-volumes up addHost

up:
	$(COMPOSE) $(ENV_FILE) $(COMPOSE_FILE) up --build -d

build:
	$(COMPOSE) $(ENV_FILE) $(COMPOSE_FILE) build

down:
	$(COMPOSE) $(COMPOSE_FILE) down

logs:
	$(COMPOSE) $(COMPOSE_FILE) logs -f

start:
	$(COMPOSE) $(COMPOSE_FILE) start

stop:
	$(COMPOSE) $(COMPOSE_FILE) stop

ps:
	$(COMPOSE) $(COMPOSE_FILE) ps

exec:
	$(COMPOSE) $(COMPOSE_FILE) exec

addHost:
	@echo "Add host $(DOMAIN)"
	@grep -qxF "127.0.0.1 $(DOMAIN)" /etc/hosts || \
		echo "127.0.0.1 $(DOMAIN)" | sudo tee -a /etc/hosts

rmHost:
	@echo "Remove host $(DOMAIN)"
	@sudo sed -i '\|127.0.0.1[[:space:]]\+$(DOMAIN)|d' /etc/hosts

init-dirs:
	@if [ ! -d "$(DATA_PATH)/db_data" ]; then \
		mkdir -p "$(DATA_PATH)/db_data"; \
		echo "Created: $(DATA_PATH)/db_data"; \
	fi
	@if [ ! -d "$(DATA_PATH)/wp_data" ]; then \
		mkdir -p "$(DATA_PATH)/wp_data"; \
		echo "Created: $(DATA_PATH)/wp_data"; \
	fi
	@chmod 755 "$(DATA_PATH)"
	@if ! grep -q "DATA_PATH=" srcs/.env; then \
		echo "DATA_PATH=$(DATA_PATH)" >> srcs/.env; \
	fi
	@if ! grep -q "USER=" srcs/.env; then \
		echo "USER=$(USER)" >> srcs/.env; \
	fi

init-volumes:
	@if ! docker volume inspect db_data >/dev/null 2>&1; then \
		docker volume create --name db_data --opt type=none --opt device=${DATA_PATH}/db_data --opt o=bind; \
	fi
	@if ! docker volume inspect wp_data >/dev/null 2>&1; then \
		docker volume create --name wp_data --opt type=none --opt device=${DATA_PATH}/wp_data --opt o=bind; \
	fi


fclean: down
	docker system prune -af

re: fclean all

.PHONY: all up build down logs start stop ps exec fclean re
